<!DOCTYPE html>
<html>
<head>
	<title>Canvace</title>
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0" />
	<link href="http://fonts.googleapis.com/css?family=Titillium+Web:300" rel="stylesheet" type="text/css">
	<link href="/css/screen.css" rel="stylesheet" type="text/css" media="screen" />
	<link href="/css/mobile.css" rel="stylesheet" type="text/css" media="screen" />
	<link href="/css/pygments.css" rel="stylesheet" type="text/css" media="all" />
	<link href="/favicon.ico" rel="icon" type="image/vnd.microsoft.icon" />
</head>
<body>

<header class="header">
	<div class="inner">
		<a class="logo" href="/"><img src="/media/logo.png" alt="Canvace" /></a>
		<ul class="menu">
			<li><a href="/games/index.html">Games</a></li>
			<li><a href="/tutorials/index.html">Docs</a></li>
			<li><a href="http://api.canvace.com/">API</a></li>
		</ul>
	</div>
</header>

<a href="https://github.com/canvace"><img style="position: fixed; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>

<div class="contents">
<ol>
	
		
	
		
	
		
			<li>
				
					<a href='/tutorials/index.html'>Introduction and installation</a>
				
			</li>
		
	
		
			<li>
				
					<a href='/tutorials/editor.html'>Development environment</a>
				
			</li>
		
	
		
			<li>
				
					Rendering a stage in the canvas
				
			</li>
		
	
		
			<li>
				
					<a href='/tutorials/entities.html'>Entities and collisions</a>
				
			</li>
		
	
		
			<li>
				
					<a href='/tutorials/pathfinding.html'>Pathfinding and animations</a>
				
			</li>
		
	
		
			<li>
				
					<a href='/tutorials/input-view.html'>Input events and stage's view</a>
				
			</li>
		
	
		
			<li>
				
					<a href='/tutorials/effects.html'>Special effects</a>
				
			</li>
		
	
		
			<li>
				
					<a href='/tutorials/state-machine.html'>State machines</a>
				
			</li>
		
	
		
			<li>
				
					<a href='/tutorials/sound.html'>Sound effects</a>
				
			</li>
		
	
		
			<li>
				
					<a href='/tutorials/http-compression.html'>Enabling HTTP compression</a>
				
			</li>
		
	
</ol>
<h1 id='displaying_a_stage_in_the_canvas'>Displaying a stage in the canvas</h1>

<p>In this chapter, we will see how Canvace displays a game stage into a canvas.</p>

<h2 id='organization_of_a_canvace_game'>Organization of a Canvace game</h2>

<p>Generally speaking, you may organize a Canvace game like this:</p>

<ul>
<li>stages directory, for the JSON files representing the stages;</li>

<li>media directory, containing all the pictures and sound files used in the game;</li>

<li>index.html: definition of the canvas (and other HTML elements external to the game if needed);</li>

<li>one or more Javascript files for the game logic.</li>
</ul>

<h2 id='stage_loading_and_rendering'>Stage loading and rendering</h2>

<p>Initially, the stage information exported by the development environment needs to be loaded into Canvace. This is done asynchronously in two separate steps.</p>

<p>First, the JSON file Stage1.json is loaded using Ajax (line 1). The anonymous function, called when the loading has completed, gets the whole data as an object. Then, the &#8220;media&#8221; directory, containing all the pictures used for the game, is loaded by instantiating a <code>Canvace.Loader</code> object and calling the <code>loadAssets()</code> method. This process may require some time; hence, a progress callback is defined in the <code>progress</code> property: it updates the status of a progress bar. We also set a function to be called at completion, and another that reports errors. The completion callback is the one that initializes all the Canvace objects and starts the actual game logic.</p>

<p>Note: the code below is just a snippet from the complete source, which tries to highlight the most important parts of these functions.</p>
<div class='highlight'><pre><code class='javascript'>    <span class='nx'>Canvace</span><span class='p'>.</span><span class='nx'>Ajax</span><span class='p'>.</span><span class='nx'>getJSON</span><span class='p'>(</span><span class='s2'>&quot;Stage1.json&quot;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>data</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='kd'>var</span> <span class='nx'>loader</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>Canvace</span><span class='p'>.</span><span class='nx'>Loader</span><span class='p'>({</span>

            <span class='nx'>basePath</span><span class='o'>:</span> <span class='s2'>&quot;media&quot;</span><span class='p'>,</span> <span class='cm'>/* where the pictures are found */</span>

            <span class='nx'>progress</span><span class='o'>:</span> <span class='p'>(</span><span class='kd'>function</span> <span class='p'>(</span><span class='nx'>bar</span><span class='p'>)</span> <span class='p'>{</span>
                <span class='k'>return</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>percentage</span><span class='p'>)</span> <span class='p'>{</span>
                    <span class='nx'>bar</span><span class='p'>.</span><span class='nx'>value</span> <span class='o'>=</span> <span class='nx'>percentage</span><span class='p'>.</span><span class='nx'>toFixed</span><span class='p'>();</span>
                <span class='p'>}</span>
            <span class='p'>}(</span> <span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementById</span><span class='p'>(</span><span class='s2'>&quot;progress&quot;</span><span class='p'>))</span> <span class='p'>),</span>

            <span class='nx'>error</span><span class='o'>:</span> <span class='nx'>errorReport</span><span class='p'>,</span>
			
            <span class='nx'>complete</span><span class='o'>:</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
                <span class='kd'>var</span> <span class='nx'>stage</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>Canvace</span><span class='p'>.</span><span class='nx'>Stage</span><span class='p'>(</span><span class='nx'>data</span><span class='p'>,</span> <span class='s2'>&quot;#tutorial&quot;</span><span class='p'>);</span>
                <span class='p'>[...]</span>
                <span class='kd'>var</span> <span class='nx'>renderLoop</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>Canvace</span><span class='p'>.</span><span class='nx'>RenderLoop</span><span class='p'>(</span><span class='nx'>stage</span><span class='p'>,</span> <span class='kc'>null</span><span class='p'>,</span> <span class='nx'>loader</span><span class='p'>,</span> <span class='nx'>animator</span><span class='p'>,</span> <span class='nx'>eventLoop</span><span class='p'>.</span><span class='nx'>loop</span><span class='p'>);</span>
                <span class='nx'>renderLoop</span><span class='p'>.</span><span class='nx'>run</span><span class='p'>();</span>
            <span class='p'>}</span>
        <span class='p'>});</span>

        <span class='nx'>loader</span><span class='p'>.</span><span class='nx'>loadAssets</span><span class='p'>(</span><span class='nx'>data</span><span class='p'>);</span>
    <span class='p'>},</span> <span class='nx'>errorReport</span><span class='p'>);</span>
</code></pre></div>
<p>As soon as the game information has been stored inside Canvace, it&#8217;s time to render the stage into the canvas. Line 15 retrieves the canvas object from the DOM. Line 16 associates a <code>Canvace.Stage</code> object with the game data and the canvas, identified by its CSS selector. This class is useful to retrieve all the game components for this stage. At last, the render loop is initialized: here we can control the periodical rendering of the stage inside the canvas. The parameters <code>animator</code> and <code>eventLoop.loop</code> define what happens to the scene between two consecutive renderings. In particular, the <code>eventLoop.loop</code> function runs the game logic: it moves the characters, manages collisions and state transitions. The <code>animator</code> is a Canvace class for animations which is described in more details in the pathfinding chapter.</p>

<p>At line 20, the <code>run()</code> method starts the rendering, and the stage is finally displayed.</p>

<p><img alt='Game stage' src='images/game-stage.png' /></p>

<p>The render loop can be later stopped calling <code>stop()</code>, and nothing will be displayed anymore: in the demonstrative game, you can see <code>stop()</code> is called at the end, when the game has been either won or lost:</p>
<div class='highlight'><pre><code class='javascript'>    <span class='kd'>function</span> <span class='nx'>lost</span><span class='p'>()</span> <span class='p'>{</span>
        <span class='nx'>renderLoop</span><span class='p'>.</span><span class='nx'>stop</span><span class='p'>();</span>
        <span class='kd'>var</span> <span class='nx'>losingScreen</span> <span class='o'>=</span> <span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementById</span><span class='p'>(</span><span class='s2'>&quot;losing-screen&quot;</span><span class='p'>);</span>
        <span class='nx'>losingScreen</span><span class='p'>.</span><span class='nx'>style</span><span class='p'>.</span><span class='nx'>display</span> <span class='o'>=</span> <span class='s2'>&quot;block&quot;</span><span class='p'>;</span>
    <span class='p'>}</span>
</code></pre></div>
<p>Line 3 and 4 overwrite the canvas, now empty, with a &#8220;You lost!&#8221; message. At winning, a similar function is invoked. Once the render loop has being stopped, it cannot be restarted anymore: if you wish to do so, call <code>suspend()</code> instead, and then <code>run()</code> to resume it.</p>
<hr />


<div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'canvace';

	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

<footer class="footer">
	<div class="inner">
		<div>
			Canvace Srl - Via Luigi Casale, 7 - 05100 Terni (Italia) - VAT/P. IVA 01485160558
			&nbsp;
			<a href="https://www.iubenda.com/privacy-policy/863492" class="iubenda-black iubenda-embed" title="Privacy Policy">Privacy Policy</a>
		</div>
		<script type="text/javascript">(function (w,d) {var loader = function () {var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src = "https://cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s,tag);}; if(w.addEventListener){w.addEventListener("load", loader, false);}else if(w.attachEvent){w.attachEvent("onload", loader);}else{w.onload = loader;}})(window, document);</script>
		<div>
			<a href="http://enlabs.it/" target="_blank"><img src="/media/enlabs.png" alt="Powered by EnLabs" /></a>
		</div>
	</div>
</footer>

</body>
</html>
